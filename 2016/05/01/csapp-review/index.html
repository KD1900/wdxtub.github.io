<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="CSAPP,复习,读厚," />





  <link rel="alternate" href="/atom.xml" title="小土刀" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="考试的目的在于明晰知识点，复习的目的在于温故知新，理解最重要。和实验中考察的不同，这一讲我们结合往年的测试题，来回顾下重点的理论知识点。">
<meta property="og:type" content="article">
<meta property="og:title" content="【读厚 CSAPP】知识点复习">
<meta property="og:url" content="http://wdxtub.com/2016/05/01/csapp-review/index.html">
<meta property="og:site_name" content="小土刀">
<meta property="og:description" content="考试的目的在于明晰知识点，复习的目的在于温故知新，理解最重要。和实验中考察的不同，这一讲我们结合往年的测试题，来回顾下重点的理论知识点。">
<meta property="og:image" content="http://wdxtub.com/images/14621199829527.jpg">
<meta property="og:image" content="http://wdxtub.com/images/14619386956596.jpg">
<meta property="og:updated_time" content="2016-08-04T14:43:51.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【读厚 CSAPP】知识点复习">
<meta name="twitter:description" content="考试的目的在于明晰知识点，复习的目的在于温故知新，理解最重要。和实验中考察的不同，这一讲我们结合往年的测试题，来回顾下重点的理论知识点。">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 4016951,
      author: '博主'
    }
  };
</script>

  <title> 【读厚 CSAPP】知识点复习 | 小土刀 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">小土刀</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Agony is my triumph</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-battery-full"></i> <br />
            
            技术
          </a>
        </li>
      
        
        <li class="menu-item menu-item-life">
          <a href="/life" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-bolt"></i> <br />
            
            生活
          </a>
        </li>
      
        
        <li class="menu-item menu-item-booklist">
          <a href="/booklist" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-diamond"></i> <br />
            
            书单
          </a>
        </li>
      
        
        <li class="menu-item menu-item-thanks">
          <a href="/thanks" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-gift"></i> <br />
            
            致谢
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                【读厚 CSAPP】知识点复习
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-01T07:39:15+08:00" content="2016-05-01">
              2016-05-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Technique/" itemprop="url" rel="index">
                    <span itemprop="name">Technique</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/01/csapp-review/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/01/csapp-review/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
              &nbsp; | &nbsp;
              <span class="page-pv"><i class="fa fa-file-o"></i>
              <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
              </span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>考试的目的在于明晰知识点，复习的目的在于温故知新，理解最重要。和实验中考察的不同，这一讲我们结合往年的测试题，来回顾下重点的理论知识点。</p>
<a id="more"></a>
<hr>
<h2 id="u6613_u9519"><a href="#u6613_u9519" class="headerlink" title="易错"></a>易错</h2><ul>
<li>只有已退出(Exited)的进程才能被回收</li>
<li>带合并的 <code>malloc</code> 的空间利用率可能更高、可能一样、可能更低（相对于不带合并的 <code>malloc</code>）</li>
<li>执行 <code>exec</code> 之后被阻塞的信号会保留</li>
<li>执行 <code>exec</code> 可能会有 0 次或 1 次返回，取决于执行有没有发生错误，有错才会返回</li>
<li>已初始化的变量保存在 ELF 二进制文件中的 <code>.data</code> 部分</li>
<li>fork 之后父进程和子进程会立即共享 open file struct</li>
<li>fork 之后会复制 file descriptor table</li>
<li>进程没有办法处理 SIGKILL 信号</li>
<li>链接器的输入可以是 <code>.o</code> 或 <code>.a</code></li>
<li>增加 cache 中的 line size 可以减少 compulsory miss</li>
<li><code>int *(*f[3])();</code> 的意思是 an array of pointers to functions that return pointers to int</li>
<li>User stack 不在 ELF 中</li>
</ul>
<p>大部分概念在例题讲解中都有介绍，这里就不专门列出了。以下这部分是关键：</p>
<ul>
<li>内部碎片包括 header 和 footer，不只是 payload 的部分</li>
<li>IO 题目的顺序需要注意，加上 fork 之后需要非常仔细</li>
<li>信号量部分需要仔细阅读题目，尤其是会阻塞相同的信号这里</li>
<li>移位数目超过数据本身的位数会出现不定结果</li>
<li>注意活锁和饥饿的区别</li>
</ul>
<h2 id="u4F8B_u9898"><a href="#u4F8B_u9898" class="headerlink" title="例题"></a>例题</h2><h3 id="u8FDB_u7A0B_u63A7_u5236_1"><a href="#u8FDB_u7A0B_u63A7_u5236_1" class="headerlink" title="进程控制 1"></a>进程控制 1</h3><p>假设下面代码中 <code>fork</code>, <code>exec</code>, <code>wait</code> 和 <code>printf</code> 都不会失败，每次调用 <code>printf</code> 之后 stdout 都会被清空(flushed)</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> global_x = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    global_x = <span class="number">17</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里 fork 永远不会失败</span></span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">        <span class="comment">// 这里是子进程</span></span><br><span class="line">        global_x++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child: %d\n"</span>, global_x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 这里是父进程</span></span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        global_x--;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Parent: %d\n"</span>, global_x);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>前面代码的输出是什么？</p>
</blockquote>
<p>这题考察的是对 <code>fork</code> 做的事情了不了解，简单来说，fork 之后不同的进程中 <code>global_x</code> 各有一份，所以子进程加 1 变成 18，父进程减 1 变成 16，具体的流程已经在注释中标出。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Child: <span class="number">18</span></span><br><span class="line">Parent: <span class="number">16</span></span><br></pre></td></tr></table></figure>
<p>另外需要注意的是父进程中的 <code>wait</code> 函数，下一题会涉及。</p>
<blockquote>
<p>如果不调用 <code>wait</code> 函数，输出会有什么变化？</p>
</blockquote>
<p>如果没有了 <code>wait</code> 函数，那么父进程不会等待子进程完成，所以可能会在子进程输出之前打印对应的语句。但是无论顺序怎么变，值是不会变化的，子进程中是 18，父进程中是 16.</p>
<blockquote>
<p>如果程序改为下面的片段，输出是否会变化？</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> global_x = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    global_x = <span class="number">17</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里 fork 永远不会失败</span></span><br><span class="line">    <span class="keyword">if</span> (!fork())</span><br><span class="line">    &#123;</span><br><span class="line">        global_x++;</span><br><span class="line">        <span class="comment">// 这里 exec 永远不会失败</span></span><br><span class="line">        execl(<span class="string">"./my_child"</span>, <span class="string">"./my_child"</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child finished\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        global_x--;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Parent: %d\n"</span>, global_x);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面是 my_child 的代码</span></span><br><span class="line"><span class="keyword">int</span> global_x;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Child: %d\n"</span>, global_x);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>父进程的输出不变，因为代码并没有什么变化，也没有其他会改变的地方。但是对于子进程来说，因为在 <code>my_child</code> 中的 <code>global_x</code>（同名变量）是未初始化，所以 <code>exec</code> 会把原来的 18 给刷掉，输出可以认为是 <code>Child: 0</code>（当然也有可能被随机初始化为 18，但是这里姑且这么考虑）</p>
<h3 id="u8FDB_u7A0B_u63A7_u5236_2"><a href="#u8FDB_u7A0B_u63A7_u5236_2" class="headerlink" title="进程控制 2"></a>进程控制 2</h3><p>下面代码的输出是什么？</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="keyword">int</span> counter = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler1</span><span class="params">(<span class="keyword">int</span> sig)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    counter = counter - <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d"</span>, counter);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    signal(SIGUSR1, handler1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d"</span>, counter);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    kill(pid, SIGUSR1);</span><br><span class="line">    waitpid(-<span class="number">1</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    counter = counter + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d"</span>, counter);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和前面的比较类似，只要意识到无论是 fork 出去的进程，还是 signal handler 都有自己的一套变量，所以可以很容易得到最终的答案是 <code>213</code></p>
<h3 id="u52A8_u6001_u5185_u5B58_u5206_u914D"><a href="#u52A8_u6001_u5185_u5B58_u5206_u914D" class="headerlink" title="动态内存分配"></a>动态内存分配</h3><p>这部分题目关键在于读题，给出的条件会极大影响最终的答案。本题中所有的问题是基于下面代码的：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> N <span class="number">32</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *pointers[N];</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">    pointers[i] = <span class="built_in">malloc</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">    <span class="built_in">free</span>(pointers[i]);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">    pointers[i] = <span class="built_in">malloc</span>(<span class="number">56</span>);</span><br></pre></td></tr></table></figure>
<p>假设 <code>malloc</code> 是用 implicit list 实现的，header 为 8 字节，没有 footer，每个 block 都需要跟 8 字节对齐（也就是大小是 8 的倍数）。使用 first-fit 策略，如果没有足够的空间，就会调用 <code>sbrk</code> 来申请满足要求的是 8 的倍数的大小的空间。不会合并和分隔 block。</p>
<blockquote>
<p>上面代码执行完毕，<code>sbrk</code> 函数一共申请了多少空间？</p>
</blockquote>
<p>$$(8+8)\times 32 + (8+56)\times 32 = 2560 \; bytes$$</p>
<p>第一个 8 是 header，必须要有的，后面第二个 8 是因为要对齐，因为不合并，所以前面申请的空间在第三次循环的时候并不能用，需要重新申请。</p>
<blockquote>
<p>代码执行完毕后，已分配的空间大小为？（包括 header 和内部碎片）</p>
</blockquote>
<p>$$(8+56) \times 32 = 2048$$</p>
<p>第一次循环中申请的空间在第二次循环中释放了，所以只剩下第三次循环的空间是已分配的</p>
<blockquote>
<p>代码执行完毕后，未分配的空间大小为？（包括 header）</p>
</blockquote>
<p>$$(8+8)\times 32=512$$</p>
<p>其实就是第二次循环中释放的部分</p>
<blockquote>
<p>用户申请的空间占使用 <code>sbrk</code> 得到的空间的比例是多少？</p>
</blockquote>
<p>这里注意是用户申请的而不是已分配的</p>
<p>$$56 \times 32 \div (16 \times 32 + 64 \times 32) = 7/10$$</p>
<p><strong>换个条件</strong></p>
<p>其他条件一致，只是这次 <code>sbrk</code> 的实现中最少需要分配 64 字节的空间，重新回答前面的四个问题：</p>
<blockquote>
<p>上面代码执行完毕，<code>sbrk</code> 函数一共申请了多少空间？</p>
</blockquote>
<p>$$(8+56)\times 32 = 2048 \; bytes$$</p>
<p>因为第一次和第三次可以用同样的，所以无须其他空间</p>
<blockquote>
<p>代码执行完毕后，已分配的空间大小为？（包括 header 和内部碎片）</p>
</blockquote>
<p>$$(8+56) \times 32 = 2048$$</p>
<p>因为第一次和第三次可以用同样的，所以无须其他空间</p>
<blockquote>
<p>代码执行完毕后，未分配的空间大小为？（包括 header）</p>
</blockquote>
<p>0</p>
<p>因为第一次和第三次可以用同样的，所以无须其他空间</p>
<blockquote>
<p>用户申请的空间占使用 <code>sbrk</code> 得到的空间的比例是多少？</p>
</blockquote>
<p>这里注意是用户申请的而不是已分配的</p>
<p>$$56 \times 32 \div (64 \times 32) = 7/8$$</p>
<h3 id="u865A_u62DF_u5185_u5B58"><a href="#u865A_u62DF_u5185_u5B58" class="headerlink" title="虚拟内存"></a>虚拟内存</h3><p>假设我们有一个页大小为 4KB 的 32 位系统，我们通过具体的计算来比较一下 1-level 页表和 2-level 页表的表现。</p>
<p><strong>对于 2-level 页表来说</strong></p>
<p>这里 page directory 和 page table 的大小都是 4KB，也就是一页的大小</p>
<blockquote>
<p>Page directory 中有多少条记录</p>
</blockquote>
<p>32 位系统中一个地址有 32 比特也就是 4 字节，一页的大小是 4K 字节，所以能够保存 <code>4K/4 = 1K = 1024</code> 个地址，对应 1024 个 page table 的地址。</p>
<blockquote>
<p>Page table 中有多少条记录</p>
</blockquote>
<p>32 位系统中一个地址有 32 比特也就是 4 字节，一页的大小是 4K 字节，所以能够保存 <code>4K/4 = 1K = 1024</code> 个地址，对应 1024 个虚拟的地址。</p>
<p>另外一个角度可以这么看，一共 32 位，一页 4KB 也就是 12 位，还剩 20 位就平均分，两层嘛，各 10 位。</p>
<blockquote>
<p>Page directory 和 page table 一共要占多少空间</p>
</blockquote>
<p>我们一共需要 1 个 page directory 和 1024 个 page table，所以就是 4KB + 4MB</p>
<p><strong>对于 1-level 页表来说</strong></p>
<p>注意这里没有给出页表的大小</p>
<blockquote>
<p>页表中需要有多少条记录</p>
</blockquote>
<p>看位数，一共 32 位，一页是 4KB 也就是 12 位，剩下的 20 位都必须塞到页表中，所以页表中一共有</p>
<p>$$2^{20} 条记录 = 1,048,576 \;条记录$$</p>
<blockquote>
<p>Page table 需要占据多少空间</p>
</blockquote>
<p>一条记录 4B，那么 1,048,576 条记录就需要 4MB(4,194,304B)</p>
<blockquote>
<p>从前面的比较可以看出，2-level 的比 1-level 的占的空间要多，为什么实际我们反而不用 1-level 的呢？</p>
</blockquote>
<p>因为实际使用的时候，我们对于内存的需要是离散的，很少需要一个完整的 2-level 页表，所以大部分情况下 2-level 只需要在内存中映射很小的一部分，占用的空间也比较少</p>
<blockquote>
<p>假设我们有一个进程，其地址空间如下，对应填写 page directory 中的内容，可选的有 <code>unallocated</code>, <code>stack</code>, <code>heap</code>, <code>text and data</code> 和 <code>kernel memory</code></p>
</blockquote>
<figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="code">+---------------------------+</span> 0xFFFFFFFF</span><br><span class="line"><span class="header">|  9MB     Stack            |</span><br><span class="line">+---------------------------+</span></span><br><span class="line"><span class="header">|  ...     Unused           |</span><br><span class="line">+---------------------------+</span></span><br><span class="line"><span class="header">|  6MB     Heap             |</span><br><span class="line">+---------------------------+</span></span><br><span class="line"><span class="header">|  4MB     Unused           |</span><br><span class="line">+---------------------------+</span></span><br><span class="line"><span class="header">|  12MB    Text and Data    |</span><br><span class="line">+---------------------------+</span></span><br><span class="line">|  16MB    Kernel Memory    |</span><br><span class="line"><span class="code">+---------------------------+</span> 0x00000000</span><br></pre></td></tr></table></figure>
<p>这里需要注意的就是顺序是相反的，page directory 的第 0 项就从 <code>0x00000000</code> 开始，然后前面也知道 page directory 中的一项表示 4MB，对照填写即可，如下：</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">----------------------</span><br><span class="line">|<span class="string"> 0  </span>|<span class="string"> kernel memory </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 1  </span>|<span class="string"> kernel memory </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 2  </span>|<span class="string"> kernel memory </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 3  </span>|<span class="string"> kernel memory </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 4  </span>|<span class="string"> text and data </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 5  </span>|<span class="string"> text and data </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 6  </span>|<span class="string"> text and data </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 7  </span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 8  </span>|<span class="string"> heap          </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 9  </span>|<span class="string"> heap          </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 10 </span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 11 </span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> 12 </span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">....</span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">n-12</span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">n-11</span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string">n-10</span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> n-9</span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> n-8</span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> n-7</span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> n-6</span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> n-5</span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> n-4</span>|<span class="string"> unallocated   </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> n-3</span>|<span class="string"> stack         </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> n-2</span>|<span class="string"> stack         </span>|</span><br><span class="line">|<span class="string">--------------------</span>|</span><br><span class="line">|<span class="string"> n-1</span>|<span class="string"> stack         </span>|</span><br><span class="line">----------------------</span><br></pre></td></tr></table></figure>
<h3 id="TLB__u76F8_u5173"><a href="#TLB__u76F8_u5173" class="headerlink" title="TLB 相关"></a>TLB 相关</h3><p>假设我们的系统设定为：</p>
<ol>
<li>two way associative TLB</li>
<li>TLB 有 8 条记录</li>
<li>页大小为 2 的 8 次方</li>
<li>虚拟内存大小为 2 的 16 次方</li>
</ol>
<p>TLB 中的数据如下：</p>
<p><img src="/images/14621199829527.jpg" alt=""></p>
<p>用以上的信息填写下表，如果信息不够的话，则不需要填写</p>
<table>
<thead>
<tr>
<th style="text-align:center">虚拟地址</th>
<th style="text-align:center">物理地址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x7E85</td>
<td style="text-align:center">? </td>
</tr>
<tr>
<td style="text-align:center">0xD301</td>
<td style="text-align:center">?</td>
</tr>
<tr>
<td style="text-align:center">?</td>
<td style="text-align:center">0x3020</td>
</tr>
<tr>
<td style="text-align:center">0xD040</td>
<td style="text-align:center">?</td>
</tr>
<tr>
<td style="text-align:center">?</td>
<td style="text-align:center">0x5830</td>
</tr>
</tbody>
</table>
<p>要做这题，需要一幅图：</p>
<p><img src="/images/14619386956596.jpg" alt=""></p>
<p>或者说，一定要理解具体的地址翻译过程，这里使用 TLB 而没有给出页表，所以如果 TLB 中没有的，或者是 Valid 为 0 的，都可以认为是信息不够。</p>
<p>我们先来看看第一个虚拟地址 <code>0x7E85</code>，为了表示方便，先写成二进制形式</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 16 进制</span></span><br><span class="line"><span class="number">0</span>x7E85</span><br><span class="line"><span class="comment"># 2 进制</span></span><br><span class="line"><span class="number">0111</span> <span class="number">1110</span> <span class="number">1000</span> <span class="number">0101</span></span><br><span class="line"><span class="comment"># 一页的大小为 2^8，也就是说前 8 位是 VPN，后面是 VPO</span></span><br><span class="line"><span class="comment"># VPO 也就是实际的 PPO</span></span><br><span class="line"><span class="comment"># 又因为 TLB 一共有 4 个 set，所以需要 2 位</span></span><br><span class="line"><span class="comment"># 重写之后是这样</span></span><br><span class="line"><span class="number">01</span> <span class="number">1111</span> <span class="number">10</span> <span class="number">1000</span> <span class="number">0101</span></span><br><span class="line"><span class="comment"># 前 6 位是 TLB tag，之后 2 位是 TLB index</span></span><br><span class="line"><span class="comment"># 所以对应的 tag 是</span></span><br><span class="line"><span class="number">0</span>x1F</span><br><span class="line"><span class="comment"># 对应的 index 是</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="comment"># 从 TLB 表中查询有</span></span><br><span class="line"><span class="comment"># index 为 2 时 且 tag 为 0x1F 对应的物理地址是</span></span><br><span class="line"><span class="number">0</span>x95</span><br><span class="line"><span class="comment"># 拼接上原来的 VPO 就是</span></span><br><span class="line"><span class="number">0</span>x9585</span><br></pre></td></tr></table></figure>
<p>按照这个方法，可以发现 <code>0xD301</code> 和 <code>0xD040</code> 都没有办法找到有效的 TLB 项。</p>
<p>然后我们来看看从物理地址到虚拟地址的翻译，以 <code>0x3020</code> 为例，首先因为后 8 位是一样的，所以不用关系，也就是说只需要关注 TLB 表中 <code>0x30</code> 的项目（Valid 同样需要为 1）。我们在 set 0 中找到了，所以知道 TLB index 为 0，然后 Tag 为 <code>0x13</code>，对应写出来就是 <code>01 0011 00</code>，拼成完整地址是 <code>0100 1100 0010 0000</code> 也就是 <code>0x4C20</code>。</p>
<p>根据这样的方法，最终的答案是：</p>
<table>
<thead>
<tr>
<th style="text-align:center">虚拟地址</th>
<th style="text-align:center">物理地址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x7E85</td>
<td style="text-align:center">0x9585</td>
</tr>
<tr>
<td style="text-align:center">0xD301</td>
<td style="text-align:center">—</td>
</tr>
<tr>
<td style="text-align:center">0x4C20</td>
<td style="text-align:center">0x3020</td>
</tr>
<tr>
<td style="text-align:center">0xD040</td>
<td style="text-align:center">—</td>
</tr>
<tr>
<td style="text-align:center">—</td>
<td style="text-align:center">0x5830</td>
</tr>
</tbody>
</table>
<h3 id="u94FE_u63A5_1"><a href="#u94FE_u63A5_1" class="headerlink" title="链接 1"></a>链接 1</h3><p>下面给出两个代码片段，写下各个符号的各个属性，具体如下表所示</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.c</span></span><br><span class="line"><span class="keyword">int</span> x = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">int</span> y;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> z = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, z());</span><br><span class="line">    x = <span class="number">0xdeadbeef</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, z());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// foo.c</span></span><br><span class="line"><span class="keyword">short</span> x;</span><br><span class="line"><span class="keyword">int</span> y = <span class="number">0x12345678</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">z</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的表格是：</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">---------------------------------------------------------------</span><br><span class="line">|<span class="string"> File   </span>|<span class="string"> Symbol </span>|<span class="string"> Strength/scope </span>|<span class="string"> Value      </span>|<span class="string"> ELF section </span>|</span><br><span class="line">|<span class="string">-------------------------------------------------------------</span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">   x    </span>|<span class="string">  strong global </span>|<span class="string">     5      </span>|<span class="string">    .data    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">----------------------------------------------------</span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">   y    </span>|<span class="string">  weak global   </span>|<span class="string">     -      </span>|<span class="string">    .data    </span>|</span><br><span class="line">|<span class="string"> main.o </span>|<span class="string">----------------------------------------------------</span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">   z    </span>|<span class="string">  local         </span>|<span class="string">     3      </span>|<span class="string">    .data    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">----------------------------------------------------</span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">  main  </span>|<span class="string">  strong global </span>|<span class="string">     -      </span>|<span class="string">    .text    </span>|</span><br><span class="line">|<span class="string">-------------------------------------------------------------</span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">   x    </span>|<span class="string">  weak global   </span>|<span class="string">     -      </span>|<span class="string">    .data    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">----------------------------------------------------</span>|</span><br><span class="line">|<span class="string"> foo.o  </span>|<span class="string">   y    </span>|<span class="string">  strong global </span>|<span class="string"> 0x12345678 </span>|<span class="string">    .data    </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">----------------------------------------------------</span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">   z    </span>|<span class="string">  strong global </span>|<span class="string">     -      </span>|<span class="string">    .text    </span>|</span><br><span class="line">---------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<h3 id="u94FE_u63A5_2"><a href="#u94FE_u63A5_2" class="headerlink" title="链接 2"></a>链接 2</h3><blockquote>
<p>给出下面两段代码，编译执行之后的输出是什么？</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.c</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">int</span> c;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = <span class="number">3</span>;</span><br><span class="line">    </span><br><span class="line">    foo();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a=%d, b=%d, c=%d\n"</span>, a, b, c);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// foo.c</span></span><br><span class="line"><span class="keyword">int</span> a, b, c;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    a = <span class="number">4</span>;</span><br><span class="line">    b = <span class="number">5</span>;</span><br><span class="line">    c = <span class="number">6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里最终输出 <code>a=1</code>, <code>b=5</code>, <code>c=3</code></p>
<p>具体说明一下，a 是 static 的，可以认为不受其他函数影响，所以仍然是原来的 1；b 在 main 中有初始化，所以是 strong 的，在 foo 中对 b 的引用实际上是引用 main 的 b，所以 b 变成 5；最后 c 会被局部变量覆盖，就是 3.</p>
<h3 id="u8F93_u5165_u8F93_u51FA"><a href="#u8F93_u5165_u8F93_u51FA" class="headerlink" title="输入输出"></a>输入输出</h3><p>下面的代码会输出什么呢？假设所有的系统调用都会成功，且 <code>read()</code> 和 <code>write()</code> 是原子的。<code>foo.txt</code> 中的内容是 <code>ABCDEFG</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 这个函数每次读取一个字符，输出后清空缓冲区</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_and_print_one</span><span class="params">(<span class="keyword">int</span> fd)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    read(fd, &amp;c, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%c"</span>, c);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// 均为只读的 file descriptor</span></span><br><span class="line">    <span class="keyword">int</span> fd1 = open(<span class="string">"foo.txt"</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">int</span> fd2 = open(<span class="string">"foo.txt"</span>, O_RDONLY);</span><br><span class="line">    read_and_print_one(fd1); <span class="comment">// 读取 fd1 第一个字符并输出 A</span></span><br><span class="line">    read_and_print_one(fd2); <span class="comment">// 读取 fd2 第一个字符并输出 A</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!fork()) <span class="comment">// fork 之后继承所有的 fd</span></span><br><span class="line">    &#123;</span><br><span class="line">        read_and_print_one(fd2); <span class="comment">// 读取 fd2 第二个字符并输出 B</span></span><br><span class="line">        read_and_print_one(fd2); <span class="comment">// 读取 fd2 第三个字符并输出 C</span></span><br><span class="line">        close(fd2); <span class="comment">// 关闭 fd2</span></span><br><span class="line">        fd2 = dup(fd1); <span class="comment">// 把 fd2 指向 fd1</span></span><br><span class="line">        read_and_print_one(fd2); <span class="comment">// 继续读取 fd1/2 第二个字符并输出 B</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read_and_print_one(fd1); <span class="comment">// 继续读取 fd1/2 第二个字符并输出 C</span></span><br><span class="line">        read_and_print_one(fd2); <span class="comment">// 继续读取 fd1/2 第二个字符并输出 D</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    close(fd1);</span><br><span class="line">    close(fd2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出是 <code>AABCBCD</code>，而 <code>foo.txt</code> 中内容不变，因为是只读的。具体的解释参见代码注释</p>
<h3 id="u5E76_u884C_u3001_u7ADE_u4E89_u4E0E_u540C_u6B65"><a href="#u5E76_u884C_u3001_u7ADE_u4E89_u4E0E_u540C_u6B65" class="headerlink" title="并行、竞争与同步"></a>并行、竞争与同步</h3><p>下面五段代码都试图做同样的事情：主线程创建另外两个线程，每个线程都打印出自己的线程 id，我们需要判断其中的 <code>myid</code> 会不会出现竞争(race)</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 版本一</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">foo</span><span class="params">(<span class="keyword">void</span> *vargp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> myid;</span><br><span class="line">    myid = *((<span class="keyword">int</span> *)vargp);</span><br><span class="line">    Free(vargp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Thread %d\n"</span>, myid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> i, *ptr;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ptr = Malloc(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        *ptr = i;</span><br><span class="line">        Pthread_create(&amp;tid[i], <span class="number">0</span>, foo, ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    Pthread_join(tid[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">    Pthread_join(tid[<span class="number">1</span>], <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个版本不会出现竞争，因为在循环中每次创建不同的指针，在不同位置，严格来说不是共享同一个变量。</p>
<hr>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 版本二</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">foo</span><span class="params">(<span class="keyword">void</span> *vargp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> myid;</span><br><span class="line">    myid = *((<span class="keyword">int</span> *)vargp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Thread %d\n"</span>, myid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">        Pthread_create(&amp;tid[i], <span class="literal">NULL</span>, foo, &amp;i);</span><br><span class="line">    Pthread_join(tid[<span class="number">0</span>], <span class="literal">NULL</span>);</span><br><span class="line">    Pthread_join(tid[<span class="number">1</span>], <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个版本会出现竞争，指针会指向同一个 <code>myid</code>。一般来说这种直接塞指针，又没有重新分配的，会有问题。</p>
<hr>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 版本三</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">foo</span><span class="params">(<span class="keyword">void</span> *vargp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> myid;</span><br><span class="line">    myid = (<span class="keyword">int</span>)vargp;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Thread %d\n"</span>, myid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">        Pthread_create(&amp;tid[i], <span class="number">0</span>, foo, i);</span><br><span class="line">    Pthread_join(tid[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">    Pthread_join(tid[<span class="number">1</span>], <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个版本不会出现竞争，因为是直接传值而不是传引用的（注意和上一个版本的区别）</p>
<hr>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 版本四</span></span><br><span class="line"><span class="keyword">sem_t</span> s; <span class="comment">// Semaphore s</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">foo</span><span class="params">(<span class="keyword">void</span> *vargp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> myid;</span><br><span class="line">    P(&amp;s);</span><br><span class="line">    myid = *((<span class="keyword">int</span> *)vargp);</span><br><span class="line">    V(&amp;s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Thread %d\n"</span>, myid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    sem_init(&amp;s, <span class="number">0</span>, <span class="number">1</span>); <span class="comment">// 这里初始化值为 1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">        Pthread_create(&amp;tid[i], <span class="number">0</span>, foo, &amp;i);</span><br><span class="line">    Pthread_join(tid[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">    Pthread_join(tid[<span class="number">1</span>], <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个版本会出现竞争条件，理解了信号量机制之后就会发现，这个代码的信号量其实等于没用。具体自己感受下（或者参考后面一个版本）</p>
<hr>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 版本五</span></span><br><span class="line"><span class="keyword">sem_t</span> s; <span class="comment">// Semaphore s</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">foo</span><span class="params">(<span class="keyword">void</span> *vargp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> myid;</span><br><span class="line">    myid = *((<span class="keyword">int</span> *)vargp);</span><br><span class="line">    V(&amp;s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Thread %d\n"</span>, myid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    sem_init(&amp;s, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 这里初始化值为 0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Pthread_create(&amp;tid[i], <span class="number">0</span>, foo, i);</span><br><span class="line">        P(&amp;s);</span><br><span class="line">    &#125;</span><br><span class="line">    Pthread_join(tid[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">    Pthread_join(tid[<span class="number">1</span>], <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个版本不会有竞争条件，自己模拟跑一次就会发现实际上这种写法限制了具体执行的顺序，所以是可以的。</p>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>其实我觉得如果认真上了整个学期的课，也看完了我写的整个系列，考试还是蛮简单的。</p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>感觉如何？</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/misc/wechat.jpg" alt="wdxtub WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CSAPP/" rel="tag">#CSAPP</a>
          
            <a href="/tags/复习/" rel="tag">#复习</a>
          
            <a href="/tags/读厚/" rel="tag">#读厚</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/04/28/in-a-flash/" rel="next" title="第十六周 - 一瞬间">
                <i class="fa fa-chevron-left"></i> 第十六周 - 一瞬间
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/05/06/portfolio/" rel="prev" title="小土刀的作品集">
                小土刀的作品集 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/05/01/csapp-review/"
           data-title="【读厚 CSAPP】知识点复习" data-url="http://wdxtub.com/2016/05/01/csapp-review/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/misc/avatar.jpg"
               alt="wdxtub" />
          <p class="site-author-name" itemprop="name">wdxtub</p>
          <p class="site-description motion-element" itemprop="description">一个逗比的碎碎念</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">591</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">830</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/wdxtub" target="_blank" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/wdxtub" target="_blank" title="微博">
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://douban.com/people/wdx" target="_blank" title="豆瓣">
                  
                  豆瓣
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/wdxtub" target="_blank" title="知乎">
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              不妨看看
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://zhchbin.github.io/" title="zhchbin" target="_blank">zhchbin</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.algorithmdog.com/" title="算法狗" target="_blank">算法狗</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.52cs.org/" title="我爱计算机" target="_blank">我爱计算机</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://jackqdyulei.github.io/" title="雷雷" target="_blank">雷雷</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://guojiex.github.io/" title="瓜瓜" target="_blank">瓜瓜</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://wdxtub.com/bookclips/" title="我的书摘" target="_blank">我的书摘</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://wdxtub.com/interview/" title="刷题笔记" target="_blank">刷题笔记</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#u6613_u9519"><span class="nav-number">1.</span> <span class="nav-text">易错</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u4F8B_u9898"><span class="nav-number">2.</span> <span class="nav-text">例题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#u8FDB_u7A0B_u63A7_u5236_1"><span class="nav-number">2.1.</span> <span class="nav-text">进程控制 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u8FDB_u7A0B_u63A7_u5236_2"><span class="nav-number">2.2.</span> <span class="nav-text">进程控制 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u52A8_u6001_u5185_u5B58_u5206_u914D"><span class="nav-number">2.3.</span> <span class="nav-text">动态内存分配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u865A_u62DF_u5185_u5B58"><span class="nav-number">2.4.</span> <span class="nav-text">虚拟内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TLB__u76F8_u5173"><span class="nav-number">2.5.</span> <span class="nav-text">TLB 相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u94FE_u63A5_1"><span class="nav-number">2.6.</span> <span class="nav-text">链接 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u94FE_u63A5_2"><span class="nav-number">2.7.</span> <span class="nav-text">链接 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u8F93_u5165_u8F93_u51FA"><span class="nav-number">2.8.</span> <span class="nav-text">输入输出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u5E76_u884C_u3001_u7ADE_u4E89_u4E0E_u540C_u6B65"><span class="nav-number">2.9.</span> <span class="nav-text">并行、竞争与同步</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u603B_u7ED3"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wdxtub</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"wdxblog"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
      
      <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
      <script src="/js/src/hook-duoshuo.js"></script>
    
  





  
  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  

  

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
